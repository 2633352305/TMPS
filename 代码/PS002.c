/*************************************************************
                      PS002源文件
 
实现功能：PS002的控制

功能说明：PS002模拟信号传感器通过ADC0832CCN模数转换大气压
***************************************************************/
#include <PS002.h>

// 定义ADC转换结果变量
unsigned int adc_value = 0;

/********************************************************
函数名称:unsigned char PS002_read0832()
函数功能:读取ADC0832数值
参数说明:无
返回值:  ADC转换结果(0-255)
********************************************************/ 
unsigned char PS002_read0832() {
    unsigned char i, dat;
    unsigned char ndat = 0;
    
    // 初始化ADC0832
    CLK_0832 = 0;       // 时钟初始为低
    CS_0832 = 1;        // 片选初始为高
    DI_0832 = 1;        // 数据输入初始为高
    
    // 启动ADC转换
    CS_0832 = 0;        // 片选拉低，开始转换
    
    // 发送通道选择位 - 选择通道0
    DI_0832 = 1;        // 起始位为1
    pulse0832();        // 产生时钟脉冲
    CLK_0832 = 1;
    pulse0832();
    CLK_0832 = 0;
    
    DI_0832 = 1;        // 单端模式D2=1
    pulse0832();
    CLK_0832 = 1;
    pulse0832();
    CLK_0832 = 0;
    
    DI_0832 = 0;        // 选择通道0 D1=0
    pulse0832();
    CLK_0832 = 1;
    pulse0832();
    CLK_0832 = 0;
    
    // 读取ADC转换结果
    for(i=0; i<8; i++) {
        CLK_0832 = 1;
        pulse0832();
        CLK_0832 = 0;
        pulse0832();
        
        // 读取DO_0832引脚状态
        if(DO_0832) {
            dat = 1;
        } else {
            dat = 0;
        }
        
        // 构建8位结果
        ndat = ndat << 1;
        ndat = ndat | dat;
    }
    
    // 结束转换
    CS_0832 = 1;        // 片选拉高，结束转换
    
    return ndat;        // 返回ADC转换结果
}

/********************************************************
函数名称:void PS002_init()
函数功能:PS002初始化
参数说明:无
********************************************************/ 
void PS002_init() {
    // 初始化ADC0832引脚
    CS_0832 = 1;        // 片选初始为高
    CLK_0832 = 0;       // 时钟初始为低
    DI_0832 = 1;        // 数据输入初始为高
    
    // 初始化ADC值
    adc_value = 0;
    
    // 读取初始ADC值
    PS002_Convert();
}

/********************************************************
函数名称:void PS002_Convert()
函数功能:PS002读取并转换
参数说明:无
********************************************************/ 
void PS002_Convert() {
    // 读取ADC值
    adc_value = PS002_read0832();
} // PS002_Convert函数结束

// <-- 在文件末尾添加空行以尝试解决警告